<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>YouTube風サイト</title>
    <link rel="stylesheet" href="/css/ionicons.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/pure-min.css"
    />
    <style>
      .ui-helper-hidden-accessible {
        color: #fff;
      }
      #author-icon {
        width: 28px !important;
        height: 28px !important;
        border-radius: 50%;
        object-fit: cover;
      }

      #channel-name {
        font-size: 20px;
      }

      a {
        text-decoration: none;
        color: #333;
      }

      #comments .channel-profile img {
        width: 32px !important;
        height: 32px !important;
        border-radius: 50% !important;
        object-fit: cover;
        margin-right: 0.5em !important;
        margin-top: 0.5em !important;
      }

      .pure-u-4-24,
      .pure-u-md-2-24 {
        padding: 0 !important;
        margin: 0 !important;
        width: 34px !important;
        height: 34px !important;
      }

      #1wiet {
        color: #fff;
      }
      .video-player-area-a {
        max-height: 45%;
      }
      .sidebar a {
        color: transparent;
        text-decoration: none;
      }
      .comments a {
        font-size: 13px;
        color: #4c4c4c;
        text-decoration: none;
      }

      .navbar {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 5%;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .navbar-logo img {
        width: 50px;
        height: auto;
      }
      .navbar-search {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 50%;
      }
      .navbar-search form {
        width: 100%;
      }
      .navbar-search input[type="search"] {
        width: 100%;
        padding: 8px 16px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 1em;
        outline: none;
      }
      #contents {
        display: flex;
        padding: 20px 5%;
      }
      #player-container {
        flex: 3;
        padding: 10px;
        width: 100%;
        text-align: left;
      }
      #player {
        max-height: 45%;
        width: 100%;
        height: auto;
        outline: none;
        border-radius: 10px;
      }
      .sidebar {
        max-width: 25%;
        flex: 1;
        padding: 10px;
        margin-top: 20px;
      }
      .thumbnail {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }
      .thumbnail img {
        width: 35%;
        margin-right: 10px;
        border-radius: 10px;
      }
      .thumbnail-text {
        display: flex;
        flex-direction: column;
      }
      .thumbnail-text .title {
        font-size: 1em;
        color: #333;
        margin: 0;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        max-width: 100%;
      }
      .thumbnail-text .channel-name {
        font-size: 0.8em;
        color: #696363;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .video-info {
        font-size: 0.75em;
        color: #999;
        margin-top: 2px;
      }
      /* 動画説明のスタイル */
      .video-description {
        margin-top: 10px;
        font-size: 0.9em;
        color: #000000;
        white-space: pre-wrap;
      }

      /* コメントセクションのスタイル */
      #comments {
        margin-top: 20px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .comment {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      /* コメントのauthor */
      .comment .comment-author {
        font-weight: bold;
        color: #333;
      }
      /* コメント */
      .comment .comment-text {
        margin-top: 5px;
        color: #555;
      }
      /* 日付 */
      .comment .comment-date {
        font-size: 0.8em;
        color: #999;
      }

      @media (max-width: 1024px) {
        #player-container {
          max-width: 100%;
          padding: 10px 0;
        }
        .navbar-logo img {
          width: 8%;
        }
        .navbar-search form {
          width: 80%;
        }
        .thumbnail img {
          width: 40%;
        }
        .sidebar {
          margin-left: 0;
        }
      }
      @media (max-width: 768px) {
        #contents {
          flex-direction: column;
        }
        .navbar-search form {
          width: 90%;
        }
        .sidebar {
          margin-top: 10px;
        }
      }
      .ui-autocomplete {
        list-style: none; /* リストのスタイルをなしにする */
        padding: 0; /* パディングをリセット */
        margin: 0; /* マージンをリセット */
        background-color: white; /* 背景色を白にする */
        z-index: 1000; /* 他の要素の上に表示するためのz-index */
        position: absolute; /* 絶対位置にする */
      }

      /* 各アイテムのスタイル */
      .ui-menu-item {
        padding: 8px; /* アイテムのパディングを設定 */
      }

      /* アイテムにホバーしたときのスタイル */
      .ui-menu-item:hover {
        background-color: #f0f0f0; /* ホバー時の背景色 */
      }
    </style>
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-logo">
        <a href="/">
          <img
            src="https://www.youtube.com/s/desktop/daa4e47c/img/favicon_144x144.png"
            alt="YouTube Icon"
          />
        </a>
      </div>

      <form class="navbar-search pure-form" action="/search" method="get">
        <fieldset>
          <input
            type="search"
            id="searchbox"
            autocomplete="off"
            autocorrect="on"
            autocapitalize="none"
            spellcheck="false"
            name="q"
            placeholder="検索"
            title="検索"
            value=""
            class="ui-autocomplete-input"
          />
        </fieldset>
      </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      $("#searchbox").autocomplete({
        source: function (request, response) {
          var url = "/suggest?keyword=" + encodeURIComponent(request.term);
          var xhr = new XMLHttpRequest();
          xhr.open("GET", url);

          xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                var results = JSON.parse(xhr.responseText);
                response(results.slice(0, 14));
              } catch (error) {
                console.error("Parsing error:", error);
                response([]);
              }
            } else {
              console.error("Request failed:", xhr.statusText);
              response([]);
            }
          };

          xhr.onerror = function () {
            console.error("Network error");
            response([]);
          };

          xhr.send();
        },
        delay: 300,
        minLength: 1,
        open: function (event, ui) {
          var navbarHeight = $(".navbar").outerHeight(); // navbarの高さを取得
          var navbarOffset = $(".navbar").offset().top; // navbarの上部位置を取得

          $(".ui-autocomplete").css({
            top: navbarOffset + navbarHeight + "px", // navbarの下に配置
            left: $("#searchbox").offset().left + "px", // 検索ボックスの左に合わせる
            width: $("#searchbox").outerWidth() + "px", // 検索ボックスの幅に合わせる
          });
        },
      });
    </script>

    <div id="contents">
      <div id="player-container">
        <span class="video-player-area-a">
          <video
            playsinline=""
            poster="https://img.youtube.com/vi/{{ g_videoid }}/0.jpg"
            id="player"
            controls=""
          >
            <source src="{{ videourls[0] }}" />
          </video>
        </span>
        <h2 id="video-title">{{ videotitle }}</h2>
        <img id="author-icon" src="{{authoricon}}" /><span id="channel-name"
          >{{ author }}</span
        >
        <p>
          投稿日: <span id="published-date"></span> ・再生回数:
          <span class="view-count" id="view-count"></span> ・ 高評価数:
          <span class="like-count" id="like-count"></span>
        </p>

        <style>
          /* 概要欄のテキスト */
          .text-container-gaiyou {
            max-height: 96px; /* 4行分の高さ */
            overflow: hidden;
            position: relative;
            font-size: 16px; /* 文字サイズを16pxに設定 */
            line-height: 1.5; /* 行間 */
          }

          /* もっと見るボタン */
          .more-button-gaiyou {
            color: rgb(91, 91, 91);
            cursor: pointer;
            text-decoration: underline;
            display: none; /* 初期状態では非表示 */
          }
        </style>

        説明
        <div class="text-container-gaiyou" id="textContainerGaiyou">
          <p id="textContentGaiyou">
            <span class="video-description" id="video-description"></span>
          </p>
        </div>
        <span
          class="more-button-gaiyou"
          id="moreButtonGaiyou"
          onclick="toggleTextGaiyou()"
        >
          もっと見る
        </span>

        <script>
          function toggleTextGaiyou() {
            const textContainer = document.getElementById(
              "textContainerGaiyou"
            );
            const moreButton = document.getElementById("moreButtonGaiyou");

            if (textContainer.style.maxHeight === "none") {
              textContainer.style.maxHeight = "96px"; // 折りたたむ際の最大高さ
              moreButton.textContent = "もっと見る";
            } else {
              textContainer.style.maxHeight = "none"; // 展開する際に制限を解除
              moreButton.textContent = "折りたたむ";
            }
          }

          function checkTextLengthGaiyou() {
            const textContainer = document.getElementById(
              "textContainerGaiyou"
            );
            const moreButton = document.getElementById("moreButtonGaiyou");

            // 設定されている最大高さ（4行分の高さ）を取得
            const maxHeight = parseFloat(
              getComputedStyle(textContainer).maxHeight
            );

            // テキストが最大高さを超える場合、ボタンを表示
            if (textContainer.scrollHeight > maxHeight) {
              moreButton.style.display = "inline"; // ボタンを表示
            } else {
              moreButton.style.display = "none"; // ボタンを非表示
            }
          }

          // テキストの変更を検知してボタンの表示を更新
          document.addEventListener("DOMContentLoaded", function () {
            const videoDescription =
              document.getElementById("video-description");

            // MutationObserverを使ってテキスト変更を監視
            const observer = new MutationObserver(checkTextLengthGaiyou);
            observer.observe(videoDescription, {
              childList: true,
              subtree: true,
            });
          });
        </script>

        <div id="comments"></div>

        <script>
          const videoId = "{{ g_videoid }}";
          const proxyUrl = `https://script.google.com/macros/s/AKfycbzVtAOrAl_T_JXC9egQMBkDCmAUqr70AzfLxlU9eR9F3S117h42bytBTMUMc0-jm6Wf/exec?videoId=api/v1/videos/${videoId}`;

          // 投稿日を日本語形式に変換
          function formatDate(dateString) {
            if (dateString.includes("months ago")) {
              return dateString.replace("months ago", "ヶ月前");
            } else if (dateString.includes("years ago")) {
              return dateString.replace("years ago", "年前");
            } else if (dateString.includes("minutes ago")) {
              return dateString.replace("minutes ago", "分前");
            } else if (dateString.includes("hours ago")) {
              return dateString.replace("hours ago", "時間前");
            } else if (dateString.includes("seconds ago")) {
              return dateString.replace("seconds ago", "秒前");
            } else if (dateString.includes("month ago")) {
              return dateString.replace("month ago", "ヶ月前");
            } else if (dateString.includes("year ago")) {
              return dateString.replace("year ago", "年前");
            } else if (dateString.includes("minute ago")) {
              return dateString.replace("minute ago", "分前");
            } else if (dateString.includes("hour ago")) {
              return dateString.replace("hour ago", "時間前");
            } else if (dateString.includes("second ago")) {
              return dateString.replace("second ago", "秒前");
            } else {
              return dateString; // 変換対象外の文字列
            }
          }

          // 再生回数や高評価数を表示フォーマットに変換
          function formatCount(count) {
            const number = Number(count);
            if (number >= 1e8) {
              return (number / 1e8).toFixed(1) + "億";
            } else if (number >= 1e4) {
              return (number / 1e4).toFixed(1) + "万";
            }
            return number; // 1万未満の場合はそのまま表示
          }

          async function fetchVideoDetails() {
            try {
              const response = await fetch(proxyUrl);
              if (!response.ok) {
                throw new Error(`APIエラー: ${response.status}`);
              }
              const videoData = await response.json();

              // 動画情報をHTMLに表示
              document.getElementById("video-title").innerText =
                videoData.title;
              const publishedDate = formatDate(videoData.publishedText); // 日付をフォーマット
              document.getElementById("published-date").innerText =
                publishedDate;
              document.getElementById("view-count").innerText = formatCount(
                videoData.viewCount
              );
              document.getElementById("video-description").innerText =
                videoData.description;
              document.getElementById("like-count").innerText = formatCount(
                videoData.likeCount
              );
            } catch (error) {
              console.error("動画情報の取得中にエラーが発生しました:", error);
            }
          }

          fetchVideoDetails();

          // コメント取得のためのXMLHttpRequest
          var xhr = new XMLHttpRequest();
          xhr.open("GET", "/comments?v=" + videoId);
          xhr.onload = function () {
            if (xhr.status != 500) {
              document.getElementById("comments").innerHTML = xhr.responseText;
            } else {
              document.getElementById("comments").innerHTML =
                "エラーが発生しました。再読み込みを試してください";
            }
          };
          xhr.send();
        </script>
      </div>

      <div class="sidebar">
        <h3>関連動画</h3>
        {% for re in res %}
        <a href="/watch?v={{ re['id'] }}" class="thumbnail">
          <img
            src="https://img.youtube.com/vi/{{ re['id'] }}/0.jpg"
            alt="関連動画"
          />
          <div class="thumbnail-text">
            <p class="title">{{ re["title"] }}</p>
            <p class="channel-name">{{ re["author"] }}</p>
            <p class="video-info view-count">{{ re["viewCount"] }}</p>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>

    <script>
      function formatViews(views) {
        const numberOfViews = Number(views);
        let formattedViews;

        if (numberOfViews >= 1e8) {
          formattedViews = (numberOfViews / 1e8).toFixed(1) + "億";
        } else if (numberOfViews >= 1e4) {
          formattedViews = (numberOfViews / 1e4).toFixed(1) + "万";
        } else {
          formattedViews = numberOfViews + "";
        }

        return formattedViews;
      }

      const playerViewCountElement = document.querySelector(".view-count");
      const playerCurrentViews =
        playerViewCountElement.textContent.split(" ")[0];
      playerViewCountElement.textContent = formatViews(playerCurrentViews);

      document
        .querySelectorAll(".video-info")
        .forEach(function (viewCountElement) {
          const currentViews = viewCountElement.textContent.split("回視聴")[0];
          viewCountElement.textContent = formatViews(currentViews) + "回視聴";
        });
    </script>
  </body>
</html>

